<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Events Platform</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #1f1e1d;
            color: #ffffff;
            line-height: 1.5;
            padding-bottom: 80px;
        }

        .header {
            background: #262624;
            padding: 16px;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tabs {
            display: flex;
            gap: 20px;
        }

        .tab {
            padding: 8px 0;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 2px solid transparent;
            transition: border-color 0.2s;
        }

        .tab.active {
            border-bottom-color: #666;
        }

        .filters-btn {
            padding: 8px 12px;
            background: transparent;
            border: 1px solid #666;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
        }

        .container {
            padding: 0 16px;
        }

        .feed {
            margin-top: 16px;
        }

        .event-card {
            background: #262624;
            border: 1px solid #444;
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .event-content {
            padding: 16px;
        }

        .event-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .event-description {
            font-size: 14px;
            opacity: 0.8;
        }

        .event-footer {
            background: #1f1e1d;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .event-author {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .author-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }

        .author-name {
            font-size: 14px;
        }

        .event-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .like-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border: none;
            border-radius: 20px;
            background: transparent;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
        }

        .like-btn.liked {
            background: rgba(255, 59, 92, 0.2);
            color: #ff3b5c;
        }

        .menu-btn {
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
        }

        .dropdown-menu {
            display: none;
        }

        .action-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            padding: 16px;
        }

        .action-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-modal-content {
            background: #262624;
            border-radius: 20px;
            width: 100%;
            max-width: 300px;
            padding: 20px;
        }

        .action-modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            text-align: center;
        }

        .action-modal-item {
            display: block;
            width: 100%;
            padding: 16px;
            border: none;
            background: #1f1e1d;
            text-align: center;
            cursor: pointer;
            font-size: 16px;
            color: #fff;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .action-modal-item:hover {
            background: #333;
        }

        .action-modal-item.danger {
            color: #ff3b5c;
        }

        .search-area {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #262624;
            padding: 12px 16px;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .search-container {
            flex: 1;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 12px 12px 40px;
            border: none;
            border-radius: 20px;
            background: #1f1e1d;
            color: #fff;
            font-size: 16px;
            outline: none;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%) scaleX(-1);
            width: 18px;
            height: 18px;
            opacity: 0.6;
        }

        .create-btn {
            width: 48px;
            height: 48px;
            border: none;
            border-radius: 50%;
            background: #666;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .create-icon {
            width: 24px;
            height: 24px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            padding: 16px;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #262624;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #1f1e1d;
        }

        .modal-user {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .modal-user-name {
            font-size: 16px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 20px;
            padding: 4px;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #fff;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #666;
            border-radius: 8px;
            background: #1f1e1d;
            color: #fff;
            font-size: 16px;
            outline: none;
        }

        .form-input:focus {
            border-color: #888;
        }

        .char-counter {
            text-align: right;
            font-size: 12px;
            color: #888;
            margin-top: 4px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .form-date-group {
            grid-column: 1 / -1;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .form-date-group label {
            font-size: 14px;
            white-space: nowrap;
        }

        .form-date-group input {
            flex: 1;
        }

        .modal-footer {
            padding: 20px;
            display: flex;
            justify-content: flex-end;
        }

        .submit-btn {
            width: 48px;
            height: 48px;
            border: none;
            border-radius: 50%;
            background: #666;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .empty {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .hidden {
            display: none !important;
        }

        .menu-container {
            position: relative;
        }

        .filter-group {
            margin-bottom: 16px;
        }

        .filter-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .filter-row select,
        .filter-row input {
            flex: 1;
            padding: 12px;
            border: 1px solid #666;
            border-radius: 8px;
            background: #1f1e1d;
            color: #fff;
            font-size: 14px;
        }

        .clear-btn {
            width: 100%;
            padding: 12px;
            border: 1px solid #666;
            border-radius: 8px;
            background: #1f1e1d;
            color: #fff;
            cursor: pointer;
        }

        @media (max-width: 480px) {
            .tabs {
                gap: 15px;
            }
            
            .tab {
                font-size: 13px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="tabs">
            <div class="tab active" data-tab="feed">Feed</div>
            <div class="tab" data-tab="my-events">My Events</div>
            <div class="tab" data-tab="favorites">Favorites</div>
            <div class="tab" data-tab="hidden">Hidden</div>
        </div>
        <button class="filters-btn" onclick="showFiltersModal()">⚙️</button>
    </div>

    <div class="container">
        <div id="feedContent" class="feed"></div>
        <div id="favoritesContent" class="feed hidden"></div>
        <div id="myEventsContent" class="feed hidden"></div>
        <div id="hiddenContent" class="feed hidden"></div>
    </div>

    <div class="search-area">
        <div class="search-container">
            <svg class="search-icon" viewBox="0 0 400 400" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M197.001 244C171.822 271.83 126.998 313 104.256 295.496C81.5174 277.992 126.998 246 156.656 220.314" stroke="currentColor" stroke-opacity="0.9" stroke-width="16" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M165.944 196.347C135.998 107 276.999 75.9996 300.776 165.974C319.017 235 211.46 292.164 175.314 213.85" stroke="currentColor" stroke-opacity="0.9" stroke-width="16" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <input type="text" class="search-input" id="searchInput" placeholder="">
        </div>
        <button class="create-btn" onclick="showCreateModal()">
            <svg class="create-icon" viewBox="0 0 400 400" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M71.8708 189.953C76.0596 179.972 67.0124 166.184 74.2179 157.188C75.8153 155.199 122.602 153.152 125.561 155.514C136.45 164.206 111.415 193.423 144.018 201.553C171.926 208.513 155.397 160.743 162.516 157.188C171.049 152.934 188.865 158.57 198.547 157.188C226.846 153.158 203.311 181.664 211.97 193.182C217.423 200.435 261.828 185.402 250.56 219.132C244.647 236.825 226.375 230.776 216.164 235.873C211.338 238.281 215.898 272.743 215.1 272.582C205.09 270.587 157.177 275.336 158.734 276.89C168.054 286.189 186.94 229.756 144.018 235.873C133.985 237.301 125.13 246.004 123.884 255.963C123.16 261.765 125.774 278.518 125.561 278.564C113.242 281.023 100.187 277.778 86.9713 281.075C84.5867 281.671 67.5038 288.431 65.9983 286.935C63.3552 284.292 66.3776 262.486 66.8373 258.788C67.5727 252.946 65.9754 240.01 71.8708 240.01C84.7533 240.01 42.0914 251.826 29.6626 235.873C17.2337 219.92 29.6626 189.953 66.8373 198.994" stroke="currentColor" stroke-opacity="0.9" stroke-width="16" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M219.962 158.69C301.398 167.678 215.1 108.884 284.641 112.13C309.301 113.281 287.258 146.158 293.857 154.973C299.085 161.97 334.878 147.654 341.615 156.653C345.643 162.039 327.578 197.327 334.074 199.496C339.004 201.142 350.98 188.742 359.204 191.096C376.15 195.952 380.691 231.713 365.907 238.979C351.123 246.245 341.747 240.521 340.777 241.5C336.129 246.154 349.597 267.685 346.642 275.102C344.754 279.832 305.714 287.83 301.398 283.503C292.4 274.481 309.369 240.976 291.344 236.459C265.56 229.998 276.039 267.893 267.046 270.902C254.301 275.16 229.326 272.582 215.1 272.582" stroke="currentColor" stroke-opacity="0.9" stroke-width="16" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
    </div>

    <!-- Action Modal -->
    <div class="action-modal" id="actionModal">
        <div class="action-modal-content">
            <div class="action-modal-title">Actions</div>
            <div id="actionModalItems"></div>
        </div>
    </div>

    <!-- Filters Modal -->
    <div class="modal" id="filtersModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Filters</h3>
                <button class="modal-close" onclick="hideFiltersModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="filter-group">
                    <div class="filter-row">
                        <select id="cityFilter">
                            <option value="">All cities</option>
                        </select>
                        <select id="categoryFilter">
                            <option value="">All categories</option>
                            <option value="meetup">Meetup</option>
                            <option value="party">Party</option>
                            <option value="sport">Sport</option>
                            <option value="culture">Culture</option>
                            <option value="business">Business</option>
                            <option value="education">Education</option>
                        </select>
                    </div>
                    <div class="filter-row">
                        <select id="genderFilter">
                            <option value="">All genders</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                        <select id="ageFilter">
                            <option value="">All ages</option>
                            <option value="16-25">16-25</option>
                            <option value="25-45">25-45</option>
                            <option value="45+">45+</option>
                        </select>
                    </div>
                    <div class="filter-row">
                        <input type="date" id="dateFromFilter" placeholder="From">
                        <input type="date" id="dateToFilter" placeholder="To">
                    </div>
                    <button class="clear-btn" onclick="clearFilters()">Clear all filters</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Event Modal -->
    <div class="modal" id="createModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-user">
                    <img class="modal-user-avatar" id="modalUserAvatar" src="" alt="">
                    <div class="modal-user-name" id="modalUserName"></div>
                </div>
                <button class="modal-close" onclick="hideCreateModal()">×</button>
            </div>
            <div class="modal-body">
                <form id="createEventForm">
                    <div class="form-group">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-input" id="eventTitle" required maxlength="64">
                        <div class="char-counter" id="titleCounter">0/64</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-input" id="eventDescription" required maxlength="350" rows="4"></textarea>
                        <div class="char-counter" id="descCounter">0/350</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Location</label>
                        <input type="text" class="form-input" id="eventCity">
                    </div>
                    <div class="form-grid">
                        <div>
                            <label class="form-label">Category</label>
                            <select class="form-input" id="eventCategory">
                                <option value="">Select category</option>
                                <option value="meetup">Meetup</option>
                                <option value="party">Party</option>
                                <option value="sport">Sport</option>
                                <option value="culture">Culture</option>
                                <option value="business">Business</option>
                                <option value="education">Education</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Gender</label>
                            <select class="form-input" id="eventGender">
                                <option value="">Any gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Age group</label>
                            <select class="form-input" id="eventAge">
                                <option value="">Any age</option>
                                <option value="16-25">16-25</option>
                                <option value="25-45">25-45</option>
                                <option value="45+">45+</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-date-group">
                        <label>From:</label>
                        <input type="date" class="form-input" id="eventDateFrom">
                        <label>To:</label>
                        <input type="date" class="form-input" id="eventDateTo">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="submit" class="submit-btn" form="createEventForm">→</button>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            POSTS_API: 'https://sub-muey.onrender.com/api',
            ACCOUNTS_API: 'https://six-z05l.onrender.com/api',
            DB_NAME: 'EventsPlatform',
            DB_VERSION: 1
        }

        let app = {
            user: null,
            db: null,
            currentTab: 'feed',
            events: new Map(),
            userMeta: { likes: new Set(), favorites: new Set(), hidden: new Set() },
            lastSync: 0,
            isOnline: navigator.onLine,
            ws: null
        }

        window.addEventListener('load', async () => {
            try {
                if (window.Telegram?.WebApp) {
                    const tg = window.Telegram.WebApp
                    tg.ready()
                    tg.expand()
                    
                    if (tg.initDataUnsafe?.user) {
                        app.user = tg.initDataUnsafe.user
                    } else {
                        app.user = { id: Date.now(), first_name: 'Demo', last_name: 'User', username: 'demo_user' }
                    }
                } else {
                    app.user = { id: Date.now(), first_name: 'Demo', last_name: 'User', username: 'demo_user' }
                }

                await initializeApp()
            } catch (error) {
                console.error('App initialization error:', error)
            }
        })

        async function initializeApp() {
            await initDB()
            await authenticateUser()
            await loadData()
            setupEventListeners()
            setupUserModal()
            startPeriodicSync()
            setupWebSocket()
        }

        function setupUserModal() {
            const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(`${app.user.first_name} ${app.user.last_name || ''}`)}&size=40&background=random`
            document.getElementById('modalUserAvatar').src = avatarUrl
            document.getElementById('modalUserName').textContent = `${app.user.first_name} ${app.user.last_name || ''}`.trim()
        }

        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(CONFIG.DB_NAME, CONFIG.DB_VERSION)
                request.onerror = () => reject(request.error)
                request.onsuccess = () => {
                    app.db = request.result
                    resolve()
                }
                request.onupgradeneeded = (event) => {
                    const db = event.target.result
                    if (!db.objectStoreNames.contains('events')) {
                        const eventsStore = db.createObjectStore('events', { keyPath: 'id' })
                        eventsStore.createIndex('createdAt', 'createdAt')
                        eventsStore.createIndex('authorId', 'authorId')
                    }
                    if (!db.objectStoreNames.contains('userMeta')) {
                        db.createObjectStore('userMeta', { keyPath: 'type' })
                    }
                    if (!db.objectStoreNames.contains('appState')) {
                        db.createObjectStore('appState', { keyPath: 'key' })
                    }
                }
            })
        }

        async function saveToIndexedDB(storeName, data) {
            const transaction = app.db.transaction([storeName], 'readwrite')
            const store = transaction.objectStore(storeName)
            if (Array.isArray(data)) {
                for (const item of data) await store.put(item)
            } else {
                await store.put(data)
            }
            return transaction.complete
        }

        async function loadFromIndexedDB(storeName, query = null) {
            const transaction = app.db.transaction([storeName], 'readonly')
            const store = transaction.objectStore(storeName)
            return query ? store.get(query) : store.getAll()
        }

        function setupWebSocket() {
            if (!app.isOnline) return
            try {
                const wsUrl = CONFIG.POSTS_API.replace('https://', 'wss://').replace('http://', 'ws://').replace('/api', '')
                app.ws = new WebSocket(wsUrl)
                app.ws.onopen = () => console.log('WebSocket connected')
                app.ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data)
                        handleWebSocketMessage(message)
                    } catch (error) {
                        console.error('WebSocket message parse error:', error)
                    }
                }
                app.ws.onclose = () => {
                    app.ws = null
                    if (app.isOnline) setTimeout(setupWebSocket, 5000)
                }
            } catch (error) {
                console.error('WebSocket setup error:', error)
            }
        }

        function handleWebSocketMessage(message) {
            const { type, data } = message
            switch (type) {
                case 'EVENT_CREATED':
                    if (data.authorId !== app.userId) {
                        app.events.set(data.id, data)
                        saveToIndexedDB('events', [data])
                        if (app.currentTab === 'feed') renderCurrentTab()
                    }
                    break
                case 'EVENT_UPDATED':
                    app.events.set(data.id, data)
                    saveToIndexedDB('events', [data])
                    renderCurrentTab()
                    break
                case 'EVENT_DELETED':
                    app.events.delete(data.id)
                    renderCurrentTab()
                    break
                case 'LIKE_UPDATED':
                    const event = app.events.get(data.eventId)
                    if (event) {
                        event.likes = data.likes
                        if (data.userId === app.userId) {
                            data.isLiked ? app.userMeta.likes.add(data.eventId) : app.userMeta.likes.delete(data.eventId)
                        }
                        app.events.set(data.eventId, event)
                        renderCurrentTab()
                    }
                    break
            }
        }

        async function authenticateUser() {
            try {
                const response = await fetch(`${CONFIG.ACCOUNTS_API}/users/auth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegramUser: app.user })
                })
                if (response.ok) {
                    const userData = await response.json()
                    app.userId = userData.id
                } else {
                    throw new Error(`Auth failed: ${response.status}`)
                }
            } catch (error) {
                app.userId = `tg_${app.user.id}`
            }
        }

        async function loadData() {
            await loadFromCache()
            await syncWithServers()
            renderCurrentTab()
        }

        async function loadFromCache() {
            try {
                const events = await loadFromIndexedDB('events')
                events.forEach(event => app.events.set(event.id, event))

                const [likes, favorites, hidden] = await Promise.all([
                    loadFromIndexedDB('userMeta', 'likes'),
                    loadFromIndexedDB('userMeta', 'favorites'),
                    loadFromIndexedDB('userMeta', 'hidden')
                ])

                if (likes) app.userMeta.likes = new Set(likes.data || [])
                if (favorites) app.userMeta.favorites = new Set(favorites.data || [])
                if (hidden) app.userMeta.hidden = new Set(hidden.data || [])

                const lastSyncState = await loadFromIndexedDB('appState', 'lastSync')
                if (lastSyncState) app.lastSync = lastSyncState.value || 0
            } catch (error) {
                console.error('Cache loading error:', error)
            }
        }

        async function syncWithServers() {
            if (!app.isOnline) return
            try {
                const [eventsResponse, userMetaResponse] = await Promise.all([
                    fetch(`${CONFIG.POSTS_API}/feed?limit=100`).catch(() => null),
                    fetch(`${CONFIG.ACCOUNTS_API}/users/${app.userId}/meta?lastSync=${app.lastSync}`).catch(() => null)
                ])

                if (eventsResponse?.ok) {
                    const eventsData = await eventsResponse.json()
                    const events = eventsData.posts || []
                    for (const event of events) app.events.set(event.id, event)
                    await saveToIndexedDB('events', events)
                }

                if (userMetaResponse?.ok) {
                    const userMeta = await userMetaResponse.json()
                    if (userMeta.isDelta) {
                        userMeta.likes?.forEach(id => app.userMeta.likes.add(id))
                        userMeta.favorites?.forEach(id => app.userMeta.favorites.add(id))
                        userMeta.hidden?.forEach(id => app.userMeta.hidden.add(id))
                    } else {
                        app.userMeta.likes = new Set(userMeta.likes || [])
                        app.userMeta.favorites = new Set(userMeta.favorites || [])
                        app.userMeta.hidden = new Set(userMeta.hidden || [])
                    }

                    await Promise.all([
                        saveToIndexedDB('userMeta', { type: 'likes', data: Array.from(app.userMeta.likes) }),
                        saveToIndexedDB('userMeta', { type: 'favorites', data: Array.from(app.userMeta.favorites) }),
                        saveToIndexedDB('userMeta', { type: 'hidden', data: Array.from(app.userMeta.hidden) })
                    ])
                }

                app.lastSync = Date.now()
                await saveToIndexedDB('appState', { key: 'lastSync', value: app.lastSync })
            } catch (error) {
                console.error('Sync error:', error)
            }
        }

        function setupEventListeners() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab))
            })

            document.getElementById('searchInput').addEventListener('input', debounce(renderCurrentTab, 300))
            document.getElementById('cityFilter').addEventListener('change', renderCurrentTab)
            document.getElementById('categoryFilter').addEventListener('change', renderCurrentTab)
            document.getElementById('genderFilter').addEventListener('change', renderCurrentTab)
            document.getElementById('ageFilter').addEventListener('change', renderCurrentTab)
            document.getElementById('dateFromFilter').addEventListener('change', renderCurrentTab)
            document.getElementById('dateToFilter').addEventListener('change', renderCurrentTab)

            document.getElementById('createEventForm').addEventListener('submit', handleCreateEvent)

            document.getElementById('eventTitle').addEventListener('input', () => {
                document.getElementById('titleCounter').textContent = `${document.getElementById('eventTitle').value.length}/64`
            })
            document.getElementById('eventDescription').addEventListener('input', () => {
                document.getElementById('descCounter').textContent = `${document.getElementById('eventDescription').value.length}/350`
            })

            document.getElementById('filtersModal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) hideFiltersModal()
            })
            document.getElementById('createModal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) hideCreateModal()
            })
            document.getElementById('actionModal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) hideActionModal()
            })

            window.addEventListener('online', () => {
                app.isOnline = true
                syncWithServers()
                setupWebSocket()
            })
            window.addEventListener('offline', () => {
                app.isOnline = false
                if (app.ws) app.ws.close()
            })
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName)
            })
            document.querySelectorAll('[id$="Content"]').forEach(content => {
                content.classList.add('hidden')
            })
            document.getElementById(`${tabName}Content`).classList.remove('hidden')
            app.currentTab = tabName
            renderCurrentTab()
        }

        function renderCurrentTab() {
            const events = getFilteredEvents()
            const container = document.getElementById(`${app.currentTab}Content`)

            if (events.length === 0) {
                container.innerHTML = '<div class="empty"><div style="font-size: 48px; margin-bottom: 16px;">📭</div><div>No events found</div></div>'
                return
            }

            container.innerHTML = events.map(event => renderEventCard(event)).join('')
            updateCityFilter(events)
        }

        function getFilteredEvents() {
            const search = document.getElementById('searchInput').value.toLowerCase()
            const city = document.getElementById('cityFilter').value
            const category = document.getElementById('categoryFilter').value
            const gender = document.getElementById('genderFilter').value
            const age = document.getElementById('ageFilter').value
            const dateFrom = document.getElementById('dateFromFilter').value
            const dateTo = document.getElementById('dateToFilter').value

            let events = Array.from(app.events.values())

            if (app.currentTab === 'favorites') {
                events = events.filter(event => app.userMeta.favorites.has(event.id))
            } else if (app.currentTab === 'my-events') {
                events = events.filter(event => event.authorId === app.userId || event.authorId === app.user?.id?.toString() || event.authorId === `tg_${app.user?.id}`)
            } else if (app.currentTab === 'hidden') {
                events = events.filter(event => app.userMeta.hidden.has(event.id))
            }

            if (search) events = events.filter(event => event.title.toLowerCase().includes(search) || event.description.toLowerCase().includes(search))
            if (city) events = events.filter(event => event.city === city)
            if (category) events = events.filter(event => event.category === category)
            if (gender) events = events.filter(event => event.gender === gender)
            if (age) events = events.filter(event => event.ageGroup === age)
            
            if (dateFrom) {
                events = events.filter(event => {
                    const eventDate = event.dateFrom || event.createdAt
                    return new Date(eventDate) >= new Date(dateFrom)
                })
            }
            if (dateTo) {
                events = events.filter(event => {
                    const eventDate = event.dateTo || event.createdAt
                    return new Date(eventDate) <= new Date(dateTo)
                })
            }

            if (app.currentTab !== 'my-events' && app.currentTab !== 'hidden') {
                events = events.filter(event => !app.userMeta.hidden.has(event.id))
            }

            events.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
            return events.slice(0, 50)
        }

        function renderEventCard(event) {
            const isLiked = app.userMeta.likes.has(event.id)
            const isOwn = event.authorId === app.userId
            const author = event.author?.fullName || event.author || 'Anonymous'
            const username = event.author?.username || ''
            const avatarUrl = event.author?.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(author)}&size=32&background=random`

            return `
                <div class="event-card">
                    <div class="event-content">
                        <div class="event-title">${escapeHtml(event.title)}</div>
                        <div class="event-description">${escapeHtml(event.description)}</div>
                    </div>
                    <div class="event-footer">
                        <div class="event-author" onclick="openUserProfile('${event.authorId}', '${username}')">
                            <img src="${avatarUrl}" alt="${author}" class="author-avatar">
                            <div class="author-name">${escapeHtml(author)}</div>
                        </div>
                        <div class="event-actions">
                            <button class="like-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${event.id}')">
                                ${isLiked ? '❤️' : '🤍'} ${event.likes || 0}
                            </button>
                            <div class="menu-container">
                                <button class="menu-btn" onclick="showActionModal('${event.id}', ${isOwn})">⋯</button>
                            </div>
                        </div>
                    </div>
                </div>
            `
        }

        function updateCityFilter(events) {
            const citySelect = document.getElementById('cityFilter')
            const currentValue = citySelect.value
            const cities = [...new Set(events.map(e => e.city).filter(Boolean))].sort()
            citySelect.innerHTML = '<option value="">All cities</option>' + cities.map(city => `<option value="${city}">${city}</option>`).join('')
            citySelect.value = currentValue
        }

        function showActionModal(eventId, isOwn) {
            const modal = document.getElementById('actionModal')
            const itemsContainer = document.getElementById('actionModalItems')
            
            if (isOwn) {
                itemsContainer.innerHTML = `
                    <button class="action-modal-item" onclick="editEvent('${eventId}'); hideActionModal()">Edit</button>
                    <button class="action-modal-item danger" onclick="deleteEvent('${eventId}'); hideActionModal()">Delete</button>
                `
            } else {
                const isFavorited = app.userMeta.favorites.has(eventId)
                const isHidden = app.userMeta.hidden.has(eventId)
                itemsContainer.innerHTML = `
                    <button class="action-modal-item" onclick="toggleFavorite('${eventId}'); hideActionModal()">${isFavorited ? 'Remove from favorites' : 'Add to favorites'}</button>
                    <button class="action-modal-item" onclick="toggleHidden('${eventId}'); hideActionModal()">${isHidden ? 'Show' : 'Hide'}</button>
                    <button class="action-modal-item danger" onclick="reportEvent('${eventId}'); hideActionModal()">Report</button>
                `
            }
            
            modal.classList.add('show')
        }

        function hideActionModal() {
            document.getElementById('actionModal').classList.remove('show')
        }

        function toggleMenu(eventId) {
            // Deprecated - replaced with showActionModal
        }

        function closeAllMenus() {
            // Deprecated - replaced with hideActionModal
        }

        async function toggleLike(eventId) {
            const event = app.events.get(eventId)
            if (!event) return

            const isLiked = app.userMeta.likes.has(eventId)
            const newLikedState = !isLiked

            try {
                if (newLikedState) {
                    app.userMeta.likes.add(eventId)
                    event.likes = (event.likes || 0) + 1
                } else {
                    app.userMeta.likes.delete(eventId)
                    event.likes = Math.max(0, (event.likes || 0) - 1)
                }

                renderCurrentTab()

                if (app.ws && app.ws.readyState === WebSocket.OPEN) {
                    app.ws.send(JSON.stringify({
                        type: 'LIKE_UPDATED',
                        data: { eventId, likes: event.likes, userId: app.userId, isLiked: newLikedState }
                    }))
                }

                await saveToIndexedDB('userMeta', { type: 'likes', data: Array.from(app.userMeta.likes) })
                await saveToIndexedDB('events', [event])

                if (app.isOnline) {
                    const [postsResponse, accountsResponse] = await Promise.all([
                        fetch(`${CONFIG.POSTS_API}/events/${eventId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ likes: event.likes })
                        }).catch(() => null),
                        newLikedState ?
                            fetch(`${CONFIG.ACCOUNTS_API}/users/${app.userId}/likes/${eventId}`, { method: 'POST' }).catch(() => null) :
                            fetch(`${CONFIG.ACCOUNTS_API}/users/${app.userId}/likes/${eventId}`, { method: 'DELETE' }).catch(() => null)
                    ])
                }
            } catch (error) {
                console.error('Like toggle error:', error)
                if (isLiked) {
                    app.userMeta.likes.add(eventId)
                    event.likes = (event.likes || 0) + 1
                } else {
                    app.userMeta.likes.delete(eventId)
                    event.likes = Math.max(0, (event.likes || 0) - 1)
                }
                renderCurrentTab()
            }
        }

        async function toggleFavorite(eventId) {
            const isFavorited = app.userMeta.favorites.has(eventId)
            const newState = !isFavorited

            try {
                newState ? app.userMeta.favorites.add(eventId) : app.userMeta.favorites.delete(eventId)
                renderCurrentTab()
                await saveToIndexedDB('userMeta', { type: 'favorites', data: Array.from(app.userMeta.favorites) })

                if (app.isOnline) {
                    await (newState ?
                        fetch(`${CONFIG.ACCOUNTS_API}/users/${app.userId}/favorites/${eventId}`, { method: 'POST' }) :
                        fetch(`${CONFIG.ACCOUNTS_API}/users/${app.userId}/favorites/${eventId}`, { method: 'DELETE' })
                    ).catch(() => null)
                }
            } catch (error) {
                console.error('Favorite toggle error:', error)
                isFavorited ? app.userMeta.favorites.add(eventId) : app.userMeta.favorites.delete(eventId)
                renderCurrentTab()
            }
        }

        async function toggleHidden(eventId) {
            const isHidden = app.userMeta.hidden.has(eventId)
            const newState = !isHidden

            try {
                newState ? app.userMeta.hidden.add(eventId) : app.userMeta.hidden.delete(eventId)
                renderCurrentTab()
                await saveToIndexedDB('userMeta', { type: 'hidden', data: Array.from(app.userMeta.hidden) })

                if (app.isOnline) {
                    await (newState ?
                        fetch(`${CONFIG.ACCOUNTS_API}/users/${app.userId}/hidden/${eventId}`, { method: 'POST' }) :
                        fetch(`${CONFIG.ACCOUNTS_API}/users/${app.userId}/hidden/${eventId}`, { method: 'DELETE' })
                    ).catch(() => null)
                }
            } catch (error) {
                console.error('Hidden toggle error:', error)
                isHidden ? app.userMeta.hidden.add(eventId) : app.userMeta.hidden.delete(eventId)
                renderCurrentTab()
            }
        }

        function editEvent(eventId) {
            console.log('Edit event:', eventId)
        }

        async function deleteEvent(eventId) {
            if (!confirm('Are you sure you want to delete this event?')) return

            try {
                app.events.delete(eventId)
                renderCurrentTab()

                if (app.isOnline) {
                    await fetch(`${CONFIG.POSTS_API}/events/${eventId}`, { method: 'DELETE' }).catch(() => null)
                }
            } catch (error) {
                console.error('Delete event error:', error)
            }
        }

        function reportEvent(eventId) {
            alert('Event reported. Thank you for helping keep our community safe.')
        }

        function openUserProfile(authorId, username) {
            try {
                if (window.Telegram?.WebApp) {
                    if (username && username !== 'undefined') {
                        const chatUrl = `https://t.me/${username}`
                        if (window.Telegram.WebApp.openTelegramLink) {
                            window.Telegram.WebApp.openTelegramLink(chatUrl)
                        } else {
                            window.open(chatUrl, '_blank')
                        }
                        return
                    }

                    let telegramId = null
                    if (authorId.startsWith('tg_')) telegramId = authorId.replace('tg_', '')

                    if (telegramId && telegramId !== 'undefined') {
                        const chatUrl = `https://t.me/user?id=${telegramId}`
                        if (window.Telegram.WebApp.openTelegramLink) {
                            window.Telegram.WebApp.openTelegramLink(chatUrl)
                        } else {
                            window.open(chatUrl, '_blank')
                        }
                    } else {
                        alert('Cannot contact this user')
                    }
                } else {
                    alert('Contact feature available only in Telegram')
                }
            } catch (error) {
                console.error('Error opening user profile:', error)
                alert('Could not open user profile. Please try again.')
            }
        }

        function showFiltersModal() {
            document.getElementById('filtersModal').classList.add('show')
        }

        function hideFiltersModal() {
            document.getElementById('filtersModal').classList.remove('show')
        }

        function showCreateModal() {
            document.getElementById('createModal').classList.add('show')
        }

        function hideCreateModal() {
            document.getElementById('createModal').classList.remove('show')
            document.getElementById('createEventForm').reset()
            document.getElementById('titleCounter').textContent = '0/64'
            document.getElementById('descCounter').textContent = '0/350'
        }

        async function handleCreateEvent(e) {
            e.preventDefault()

            const title = document.getElementById('eventTitle').value.trim()
            const description = document.getElementById('eventDescription').value.trim()
            const city = document.getElementById('eventCity').value.trim()
            const category = document.getElementById('eventCategory').value
            const gender = document.getElementById('eventGender').value
            const ageGroup = document.getElementById('eventAge').value
            const dateFrom = document.getElementById('eventDateFrom').value
            const dateTo = document.getElementById('eventDateTo').value

            if (!title || !description) {
                alert('Please fill in title and description')
                return
            }

            try {
                const eventData = {
                    title, description, city, category, gender, ageGroup, dateFrom, dateTo,
                    authorId: app.userId,
                    author: {
                        fullName: `${app.user.first_name} ${app.user.last_name || ''}`.trim(),
                        username: app.user.username || '',
                        telegramId: app.user.id,
                        avatar: `https://ui-avatars.com/api/?name=${encodeURIComponent(`${app.user.first_name} ${app.user.last_name || ''}`)}&size=40&background=random`
                    }
                }

                const localEvent = {
                    id: `local_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    ...eventData,
                    likes: 0,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    status: 'active'
                }

                app.events.set(localEvent.id, localEvent)

                if (app.ws && app.ws.readyState === WebSocket.OPEN) {
                    app.ws.send(JSON.stringify({ type: 'EVENT_CREATED', data: localEvent }))
                }
                await saveToIndexedDB('events', [localEvent])

                hideCreateModal()
                renderCurrentTab()

                if (app.isOnline) {
                    try {
                        const response = await fetch(`${CONFIG.POSTS_API}/events`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(eventData)
                        })

                        if (response.ok) {
                            const serverEvent = await response.json()
                            app.events.delete(localEvent.id)
                            app.events.set(serverEvent.id, serverEvent)
                            await saveToIndexedDB('events', [serverEvent])
                            renderCurrentTab()
                        }
                    } catch (error) {
                        console.error('Server sync failed:', error)
                    }
                }
            } catch (error) {
                console.error('Create event error:', error)
            }
        }

        function clearFilters() {
            document.getElementById('searchInput').value = ''
            document.getElementById('cityFilter').value = ''
            document.getElementById('categoryFilter').value = ''
            document.getElementById('genderFilter').value = ''
            document.getElementById('ageFilter').value = ''
            document.getElementById('dateFromFilter').value = ''
            document.getElementById('dateToFilter').value = ''
            renderCurrentTab()
            hideFiltersModal()
        }

        function escapeHtml(text) {
            const div = document.createElement('div')
            div.textContent = text
            return div.innerHTML
        }

        function debounce(func, wait) {
            let timeout
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout)
                    func(...args)
                }
                clearTimeout(timeout)
                timeout = setTimeout(later, wait)
            }
        }

        function startPeriodicSync() {
            setInterval(() => {
                if (app.isOnline) {
                    syncWithServers()
                    if (!app.ws || app.ws.readyState !== WebSocket.OPEN) setupWebSocket()
                }
            }, 30000)
        }
    </script>
</body>
</html>
